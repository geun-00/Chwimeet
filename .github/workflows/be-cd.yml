name: be-cd

on:
  push:
    branches: ["main"]
    paths:
      - "backend/src/**"
      - "backend/build.gradle.kts"
      - "backend/Dockerfile"
      - ".github/workflows/be-cd.yml"

permissions:
  contents: read
  packages: write

concurrency:
  group: be-cd-${{ github.ref }}
  cancel-in-progress: false # ë°°í¬ëŠ” ì·¨ì†Œí•˜ì§€ ì•ŠìŒ

env:
  REGISTRY: ghcr.io
  # âœ¨ [ìˆ˜ì •] IMAGE_NAME ì •ì˜ë¥¼ ì œê±°í–ˆìŠµë‹ˆë‹¤. JOB ë‚´ë¶€ì—ì„œ ë™ì ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤.

defaults:
  run:
    working-directory: backend

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    outputs:
      image-tag: ${{ steps.meta.outputs.tags }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # âœ¨ [ìˆ˜ì •] ì´ ë‹¨ê³„ì—ì„œ OWNER_LCë¥¼ ì„¤ì •í•˜ê³ , IMAGE_NAMEì„ ì¦‰ì‹œ ì„¤ì •í•©ë‹ˆë‹¤.
      - name: Set owner name and image name
        run: |
          # 1. OWNER_LC ì„¤ì • (ì†Œë¬¸ìží™”)
          OWNER_LC=${{ github.repository_owner }}
          OWNER_LC=${OWNER_LC,,} 
          echo "OWNER_LC=$OWNER_LC" >> $GITHUB_ENV

          # 2. IMAGE_NAME ì„¤ì • (GHCR ê·œì¹™ì— ë§žê²Œ ì†Œë¬¸ìž ì†Œìœ ìž ì´ë¦„ ì‚¬ìš©)
          IMAGE_NAME="$OWNER_LC/chwimeet-backend"
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver: docker-container

      # gradle wrapper ë³´ì•ˆ ê²€ì¦
      - name: Validate Gradle Wrapper
        uses: gradle/wrapper-validation-action@v2
        with:
          gradle-wrapper-path: backend/gradle/wrapper/gradle-wrapper.jar

      # Gradle ì‹¤í–‰ JVM(JDK 24)
      - name: Setup Java (Gradle JVM = 24)
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "24"
          cache: gradle
          cache-dependency-path: backend/build.gradle.kts

      # ì½”ë“œ toolchainìš© JDK 25 ë¯¸ë¦¬ ì„¤ì¹˜
      - name: Provision Java 25 for toolchain
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "25"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
        with:
          gradle-version: wrapper
          build-root-directory: backend

      - name: Make gradlew executable
        run: chmod +x ./gradlew

      # ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸ - CIì—ì„œ ì´ë¯¸ í…ŒìŠ¤íŠ¸ ì™„ë£Œ)
      - name: Build with Gradle
        run: ./gradlew clean bootJar -x test --no-daemon

      # Docker ë©”íƒ€ë°ì´í„° ì¶”ì¶œ
      - name: Extract Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          # âœ¨ ìˆ˜ì •: env.IMAGE_NAMEì´ Stepì—ì„œ ì„¤ì •ë˜ì—ˆìœ¼ë¯€ë¡œ ì´ì œ ì ‘ê·¼ ê°€ëŠ¥
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=ref,event=branch
            type=semver,pattern={{version}}
            type=semver,pattern={{major}}.{{minor}}

      # GHCR ë¡œê·¸ì¸
      - name: Login to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      # Docker ì´ë¯¸ì§€ ë¹Œë“œ ë° Push
      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          # cache-fromê³¼ cache-toëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€
          cache-from: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache
          cache-to: type=registry,ref=${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:buildcache,mode=max

      - name: Image digest
        run: echo "ðŸ³ Pushed image - ${{ steps.meta.outputs.tags }}"

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    timeout-minutes: 10

    # ðŸ”¥ ì—¬ê¸°ì„œ build-and-pushì˜ backend ë””ë ‰í† ë¦¬ ê¸°ë³¸ê°’ì„ ë®ì–´ì”€
    defaults:
      run:
        working-directory: .   # ë£¨íŠ¸ì—ì„œ ì‹¤í–‰

    environment:
      name: production
      url: https://${{ vars.APP_DOMAIN }}

    steps:
      # (ì„ íƒ) ì½”ë“œê°€ í•„ìš” ì—†ìœ¼ë©´ checkoutì€ ìƒëžµí•´ë„ ë¨
      # - name: Checkout
      #   uses: actions/checkout@v4

      # 1. AWS ìžê²© êµ¬ì„±
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}

      # 2. Name íƒœê·¸ë¡œ EC2 ì¸ìŠ¤í„´ìŠ¤ ì¡°íšŒ
      - name: Get Instance ID
        id: get_instance_id
        env:
          EC2_INSTANCE_TAG_NAME: team1-backend
        shell: bash
        run: |
          set -e
          
          echo "ðŸ” Finding EC2 instance with tag Name=${EC2_INSTANCE_TAG_NAME}"
          
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=${EC2_INSTANCE_TAG_NAME}" "Name=instance-state-name,Values=running" \
            --query "Reservations[].Instances[].InstanceId" --output text)
          
          echo "INSTANCE_ID raw: '${INSTANCE_ID}'"
          
          # âœ… ì—¬ê¸°ì„œ ì•ˆì „í•˜ê²Œ ê²€ì¦ (ê´„í˜¸/ë³µìž¡í•œ ë¬¸ë²• ì—†ì´)
          if [ -z "${INSTANCE_ID}" ] || [ "${INSTANCE_ID}" = "None" ]; then
            echo "No running instance found"
            exit 1
          fi
          
          echo "âœ… Found instance: ${INSTANCE_ID}"
          echo "INSTANCE_ID=${INSTANCE_ID}" >> "${GITHUB_ENV}"
